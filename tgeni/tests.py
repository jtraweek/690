import app
import app.models   as models
import os
import unittest
import urllib
import tempfile

from app            import tgeni, db
from flask          import url_for
from unittest       import TestCase
from flask_login    import current_user, AnonymousUserMixin


class BaseTestCase(TestCase):
    """ Some base test case methods to be used for all test cases.
    """
    def setUp(self):
        tgeni.config.from_object('config.TestConfig')
        self.client = tgeni.test_client()
        # Start with a fresh db.
        db.drop_all()
        db.create_all()
        # Ensure we are in testing mode.
        self.assertFalse(tgeni.debug)

    def tearDown(self):
        pass

    def register(self, username, email, password):
        return self.client.post(
            '/register',
            data=dict(username=username, email=email, password=password),
            follow_redirects=True
            )

    def login(self, username, password):
        return self.client.post(
            '/signin',
            data=dict(username=username, password=password),
            follow_redirects=True
            )

    def logout(self):
        return self.client.get(
            '/signout',
            follow_redirects=True
            )


class CRUDMixinTestCase(BaseTestCase):

    def test_create(self):
        test_user = models.User.create(username='test_user',
                                        email='test_user@email.web',
                                        password='pwd')
        self.assertEqual(test_user.username, 'test_user')
        self.assertEqual(test_user.email, 'test_user@email.web')
        self.assertTrue(test_user.password_matches('pwd'))

    def test_get(self):
        test_user = models.User.create(username='test_user',
                                        email='test_user@email.web',
                                        password='pwd')
        lookup_user = models.User.get(test_user.id)
        self.assertIsNotNone(test_user)

    def test_update(self):
        test_user = models.User.create(username='test_user',
                                        email='test_user@email.web',
                                        password='pwd')
        test_user.update(username='different_name', email='different@email.web')
        self.assertEqual(test_user.username, 'different_name')
        self.assertEqual(test_user.email, 'different@email.web')

    def test_delete(self):
        user_id = 42
        test_user = models.User.create(
                                id=user_id,
                                username='test_user',
                                email='test_user@email.web',
                                password='pwd')
        self.assertIsNotNone(models.User.get(user_id))
        test_user.delete()
        self.assertIsNone(models.User.get(user_id))


class IndexViewTestCase(BaseTestCase):
    """
    """
    def test_index(self):
        """ Test that the main index page renders.
        """
        response =  self.client.get('/', follow_redirects=True)
        self.assertEqual(response.status_code, 200)
        self.assertIn('Travel Geni', str(response.data))


class RegisterViewTestCase(BaseTestCase):
    """
    """
    def test_register_renders(self):
        response =  self.client.get('/register', follow_redirects=True)
        self.assertEqual(response.status_code, 200)
        self.assertIn('Register', str(response.data))
        self.assertIn('Sign Up', str(response.data))

    def test_register(self):
        """ Test that a valid registration works.
        """
        response = self.register(username='test', email='testuser@email.web', password='testpwd')
        self.assertEqual(response.status_code, 200)
        user = models.User.query.filter_by(username='test').first()
        self.assertIsNotNone(user)
        self.assertEqual(user.username, 'test')
        self.assertEqual(user.email, 'testuser@email.web')
        self.assertTrue(user.password_matches('testpwd'))

    def test_register_username_taken(self):
         self.register(username='test', email='testuser@email.web', password='testpwd')
         response = self.register(username='test', email='testuser@email.web', password='testpwd')
         self.assertIn('Username already take', str(response.data))

    def test_register_missing_input(self):
        """ Test register with required fields left blank.
        """
        response = self.register(username='', email='testuser@email.web', password='testpwd')
        self.assertIn('This field is required.', str(response.data))
        response = self.register(username='test', email='', password='testpwd')
        self.assertIn('This field is required.', str(response.data))
        response = self.register(username='test', email='testuser@email.web', password='')
        self.assertIn('This field is required.', str(response.data))

    def test_register_missing_input(self):
        response = self.register(username='test', email='invalidemail', password='testpwd')
        self.assertIn('Invalid email address.', str(response.data))


class SigninViewTestCase(BaseTestCase):
    """
    """
    def test_signin_renders(self):
        response =  self.client.get('/signin', follow_redirects=True)
        self.assertEqual(response.status_code, 200)
        self.assertIn('Sign In', str(response.data))
        self.assertIn('Username', str(response.data))
        self.assertIn('Password', str(response.data))

    def test_signin(self):
        """ Test that a user can sign in with valid credentials.
        """
        self.register(username='testuser', email='testuser@email.web', password='testpwd')
        with self.client:
            response = self.login('testuser', 'testpwd')
            self.assertEqual(response.status_code, 200)
            self.assertIn('testuser', str(response.data))
            self.assertTrue(current_user.is_authenticated)

    def test_signin_invalid_username(self):
        """ Test signin with a nonexistent user.
        """
        with self.client:
            response = self.login('testuser', 'testpwd')
            self.assertIn('Invalid username or password', str(response.data))
            self.assertFalse(current_user.is_authenticated)

    def test_signin_invalid_password(self):
        """ Test signin with mismatched password.
        """
        self.register(username='testuser', email='testuser@email.web', password='testpwd')
        with self.client:
            response = self.login('testuser', 'wrongpwd')
            self.assertIn('Invalid username or password', str(response.data))
            self.assertFalse(current_user.is_authenticated)

    def test_signin_missing_input(self):
        """ Test signin with required fields left blank.
        """
        with self.client:
            response = self.login('', '')
            self.assertIn('This field is required.', str(response.data))
            self.assertFalse(current_user.is_authenticated)
            response = self.login('provided', '')
            self.assertIn('This field is required.', str(response.data))
            self.assertFalse(current_user.is_authenticated)
            response = self.login('', 'provided')
            self.assertIn('This field is required.', str(response.data))
            self.assertFalse(current_user.is_authenticated)


class SignoutViewTestCase(BaseTestCase):
    """
    """
    def test_signout(self):
        """ Test that a user can sign out properly.
        """
        self.register(username='testuser', email='testuser@email.web', password='testpwd')
        with self.client:
            self.login('testuser', 'testpwd')
            response = self.logout()
            self.assertNotIn('testuser', str(response.data))
            self.assertFalse(current_user.is_authenticated)


class ErrorHandlerTestCase(BaseTestCase):
    """ Test HTTP error message pages.
    """
    def test_404(self):
        response =  self.client.get('/nonexistent')
        self.assertIn('Oh no, 404!', str(response.data))


if __name__ == '__main__':
    unittest.main()
